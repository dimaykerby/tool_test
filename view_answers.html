<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizza Risposte - Up to Ten</title>
  <link rel="stylesheet" href="header.css">
  <link rel="stylesheet" href="view-answers.css">
  <link rel="stylesheet" href="floating-back-button.css">
  
  <!-- MathJax per formule matematiche -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>
<body>
  <!-- Header -->
  <div id="header-placeholder"></div>

  <!-- Container principale -->
  <div class="main-container" id="mainContainer">
    <!-- Pannello sinistro: PDF viewer (se disponibile) -->
    <div id="pdfPanel" class="pdf-panel">
      <button class="toggle-panel-btn" id="togglePdfPanel" title="Nascondi PDF">‚óÄ</button>
      <iframe id="pdfFrame" class="pdf-frame"></iframe>
    </div>
    
    <!-- Pannello destro: Risposte -->
    <div id="answersPanel" class="answers-panel">
      <!-- Header della sezione risposte -->
      <div class="answers-header">
        <div class="header-content">
          <h2 id="testTitle">Risposte dello studente</h2>
          <p id="testInfo" class="test-info"></p>
        </div>
        <div class="header-actions">
          <button id="printBtn" class="action-btn print-btn">
            üñ®Ô∏è Stampa Report
          </button>
        </div>
      </div>

      <!-- Statistiche -->
      <div class="stats-container">
        <div class="stat-card correct">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-number" id="correctCount">0</div>
            <div class="stat-label">Corrette</div>
          </div>
        </div>
        <div class="stat-card wrong">
          <div class="stat-icon">‚ùå</div>
          <div class="stat-content">
            <div class="stat-number" id="wrongCount">0</div>
            <div class="stat-label">Errate</div>
          </div>
        </div>
        <div class="stat-card unsure">
          <div class="stat-icon">‚ùì</div>
          <div class="stat-content">
            <div class="stat-number" id="unsureCount">0</div>
            <div class="stat-label">Insicuro</div>
          </div>
        </div>
        <div class="stat-card no-idea">
          <div class="stat-icon">ü§∑</div>
          <div class="stat-content">
            <div class="stat-number" id="noIdeaCount">0</div>
            <div class="stat-label">Non ho idea</div>
          </div>
        </div>
        <div class="stat-card skipped">
          <div class="stat-icon">‚è≠Ô∏è</div>
          <div class="stat-content">
            <div class="stat-number" id="skippedCount">0</div>
            <div class="stat-label">Non date</div>
          </div>
        </div>
        <div class="stat-card timeout">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-content">
            <div class="stat-number" id="timeoutCount">0</div>
            <div class="stat-label">Tempo esaurito</div>
          </div>
        </div>
        <div class="stat-card percentage">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-number" id="percentageScore">0%</div>
            <div class="stat-label">Punteggio</div>
          </div>
        </div>
      </div>

      <!-- Filtri risposte -->
      <div class="filters-container" id="filtersContainer" style="display: none;">
        <h3>üîç Filtra risposte:</h3>
        <div class="filter-buttons">
          <label class="filter-checkbox">
            <input type="checkbox" id="filterCorrect" value="correct" checked>
            <span class="filter-label correct">‚úÖ Corrette</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="filterWrong" value="wrong" checked>
            <span class="filter-label wrong">‚ùå Errate</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="filterUnsure" value="unsure" checked>
            <span class="filter-label unsure">‚ùì Insicuro</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="filterNoIdea" value="no-idea" checked>
            <span class="filter-label no-idea">ü§∑ Non ho idea</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="filterSkipped" value="skipped" checked>
            <span class="filter-label skipped">‚è≠Ô∏è Non date</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" id="filterTimeout" value="timeout" checked>
            <span class="filter-label timeout">‚è±Ô∏è Tempo esaurito</span>
          </label>
        </div>
        <div class="filter-actions">
          <button class="filter-btn" id="selectAll">Seleziona tutto</button>
          <button class="filter-btn" id="deselectAll">Deseleziona tutto</button>
        </div>
      </div>

      <!-- Bottone per mostrare/nascondere filtri -->
      <div class="toggle-filters-container">
        <button id="toggleFilters" class="toggle-filters-btn">
          üîç Mostra filtri
        </button>
      </div>

      <!-- Lista domande e risposte -->
      <div id="questionsContainer" class="questions-container">
        <div id="questionsList" class="questions-list"></div>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Caricamento risposte...</p>
  </div>

  <!-- Scripts -->
  <script>
    // Carica l'header
    fetch('header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
      });
    
    // Toggle pannello PDF
    document.getElementById('togglePdfPanel').addEventListener('click', function() {
      const pdfPanel = document.getElementById('pdfPanel');
      const answersPanel = document.getElementById('answersPanel');
      const btn = this;
      
      if (pdfPanel.classList.contains('collapsed')) {
        // Mostra il pannello PDF
        pdfPanel.classList.remove('collapsed');
        answersPanel.classList.remove('expanded');
        btn.textContent = '‚óÄ';
        btn.title = 'Nascondi PDF';
        // Rimuovi il bottone mostra PDF se esiste
        answersPanel.querySelector('.toggle-pdf-btn')?.remove();
      } else {
        // Nascondi il pannello PDF
        pdfPanel.classList.add('collapsed');
        answersPanel.classList.add('expanded');
        btn.style.display = 'none'; // Nascondi anche il bottone toggle
        
        // Aggiungi bottone per mostrare PDF nell'header delle risposte
        if (!answersPanel.querySelector('.toggle-pdf-btn')) {
          const headerActions = answersPanel.querySelector('.header-actions');
          if (headerActions) {
            const showPdfBtn = document.createElement('button');
            showPdfBtn.className = 'action-btn toggle-pdf-btn';
            showPdfBtn.innerHTML = 'üìÑ Mostra PDF';
            showPdfBtn.onclick = () => {
              pdfPanel.classList.remove('collapsed');
              answersPanel.classList.remove('expanded');
              btn.textContent = '‚óÄ';
              btn.style.display = 'block'; // Mostra di nuovo il bottone toggle
              showPdfBtn.remove();
            };
            headerActions.insertBefore(showPdfBtn, headerActions.firstChild);
          }
        }
      }
    });

    // Funzione stampa
    document.getElementById('printBtn').addEventListener('click', function() {
      window.print();
    });

    // Toggle filtri
    document.getElementById('toggleFilters').addEventListener('click', function() {
      const filtersContainer = document.getElementById('filtersContainer');
      const toggleBtn = this;
      
      if (filtersContainer.style.display === 'none') {
        filtersContainer.style.display = 'block';
        toggleBtn.innerHTML = 'üîç Nascondi filtri';
        // Applica i filtri quando vengono mostrati
        setTimeout(() => {
          const event = new Event('change');
          document.querySelector('.filter-checkbox input[type="checkbox"]')?.dispatchEvent(event);
        }, 100);
      } else {
        filtersContainer.style.display = 'none';
        toggleBtn.innerHTML = 'üîç Mostra filtri';
      }
    });

    // Setup filtri
    function setupFilters() {
      const checkboxes = document.querySelectorAll('.filter-checkbox input[type="checkbox"]');
      const selectAllBtn = document.getElementById('selectAll');
      const deselectAllBtn = document.getElementById('deselectAll');
      
      // Funzione per applicare i filtri
      function applyFilters() {
        const activeFilters = [];
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            activeFilters.push(checkbox.value);
          }
        });
        
        // Mostra/nascondi domande in base ai filtri
        document.querySelectorAll('.question-item').forEach(item => {
          const hasActiveClass = activeFilters.some(filter => 
            item.classList.contains(filter) || 
            (filter === 'skipped' && !item.classList.contains('correct') && 
             !item.classList.contains('wrong') && !item.classList.contains('unsure') && 
             !item.classList.contains('no-idea') && !item.classList.contains('timeout'))
          );
          
          item.style.display = hasActiveClass ? 'block' : 'none';
        });
        
        // Aggiorna contatore visibile
        const visibleCount = document.querySelectorAll('.question-item:not([style*="display: none"])').length;
        const totalCount = document.querySelectorAll('.question-item').length;
        
        // Aggiorna info nel container
        let filterInfo = document.getElementById('filterInfo');
        if (!filterInfo) {
          filterInfo = document.createElement('div');
          filterInfo.id = 'filterInfo';
          filterInfo.className = 'filter-info';
          document.querySelector('.filters-container').appendChild(filterInfo);
        }
        filterInfo.textContent = `Mostrando ${visibleCount} di ${totalCount} domande`;
      }
      
      // Event listener per ogni checkbox
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
      });
      
      // Seleziona tutto
      selectAllBtn.addEventListener('click', () => {
        checkboxes.forEach(checkbox => checkbox.checked = true);
        applyFilters();
      });
      
      // Deseleziona tutto
      deselectAllBtn.addEventListener('click', () => {
        checkboxes.forEach(checkbox => checkbox.checked = false);
        applyFilters();
      });
      
      // Applica filtri iniziali (non eseguire all'avvio perch√© i filtri sono nascosti)
      // setTimeout(applyFilters, 500); // Rimosso
    }
    
    // Inizializza filtri quando il DOM √® pronto
    document.addEventListener('DOMContentLoaded', setupFilters);
  </script>
  
  <!-- Script principale per caricare le risposte -->
  <script type="module" src="view-answers-logic.js"></script>
  <script src="floating-back-button.js"></script>
  <script>
    // Crea il bottone floating per tornare alla dashboard
    document.addEventListener('DOMContentLoaded', function() {
      createFloatingBackButton({
        targetUrl: 'view_tests.html',
        tooltip: 'Torna alla visualizzazione test'
      });
    });
  </script>
</body>
</html>